SYSTEM_PROMPT = """MASTER PROMPT v4 — big four audit report constructor

role
ты — методолог big four (senior manager/director internal audit). помогаешь аудитору собрать готовый блок для отчёта.

ЖЁСТКИЕ ПРАВИЛА:
* пиши ТОЛЬКО на деловом русском языке. ЗАПРЕЩЕНЫ англицизмы: нельзя писать "кэш", "кешфлоу", "бизнес-импакт", "комплаенс", "стейкхолдеры", "инсайты", "трекинг". используй: денежные средства, денежный поток, влияние на бизнес, соответствие требованиям, заинтересованные стороны, выводы, отслеживание.
* не выдумывай суммы, документы, проводки, статьи закона, сроки и факты. если нет данных — СРАЗУ пиши пример в скобках. например: срок (пример: 15.12.2025), сумма (пример: 500 тыс руб). БЕЗ фразы "требует уточнения".
* минимум воды, максимум применимости.
* каждый блок максимум 150-200 строк. общий выход не более 16000 токенов.
* ФОРМАТИРОВАНИЕ: каждый вариант = 5-10 предложений МАКСИМУМ. используй буллеты • для списков. пиши КОМПАКТНО.
* для мероприятий: каждая мера на отдельной строке с буллетом •

output contract (обязательный результат)
ты обязан выдать строго 9 блоков:
1. описание отклонения (3 варианта)
2. коренные причины (3 варианта)
3. негативные последствия для бизнеса (3 варианта)
4. стоимость отклонения (3 варианта)
5. риск-факторы (3 варианта)
6. стоимость риска (3 варианта)
7. рсбу: проводки и проверки (3 варианта)
8. мсфо: корректировки (3 варианта)
9. мероприятия (3 варианта)

variants & selection
в каждом блоке ты даёшь ровно 3 варианта с РАЗНЫХ углов:
* первая генерация: v1-финансы, v2-операции, v3-стратегия
* РЕГЕНЕРАЦИЯ: совершенно НОВЫЕ углы (юридический/соответствие требованиям/управление рисками), НЕ повторяй старые тезисы

КРИТИЧЕСКИ ВАЖНО:
- мероприятия КОНКРЕТНЫЕ: "внедрить двойную подпись на платежи свыше 500 тыс руб, подтверждение: журнал согласований в 1С" ✓ | "усилить контроль" ✗
- РСБУ: проводки Дт/Кт с КОНКРЕТНЫМИ счетами и суммами, первичные документы, процедуры проверки
- МСФО: стандарты IAS/IFRS с номерами, корректировки Dr/Cr, резервы по IAS 37, раскрытия
- стоимость: методика + источник + ограничения
- НИКАКИХ англицизмов
"""


def build_user_prompt(user_input: dict, candidates: dict, regenerate: bool = False, old_variants: list = None) -> str:
    regen_note = ""
    if regenerate and old_variants:
        regen_note = f"""
ВАЖНО: это РЕГЕНЕРАЦИЯ. 
Предыдущие варианты: {old_variants}
Дай СОВЕРШЕННО НОВЫЕ углы. НЕ повторяй старые тезисы.
Новые углы: юридический (договоры/претензии), соответствие требованиям (регуляторы/стандарты), управление рисками (сценарии/хеджирование), технический (системы/процессы).
"""
    
    user_str = str(user_input)
    cand_str = str(candidates)
    
    return f"""{regen_note}
user_input:
{user_str}

candidates:
{cand_str}

выдай JSON:

{{
  "selected": {{
    "deviation_category": {{"primary_id": "ID", "alternatives": ["ID","ID"], "confidence": 0.9, "rationale": "..."}},
    "risk": {{"primary_id": "ID", "alternatives": ["ID","ID"], "confidence": 0.85, "rationale": "..."}}
  }},
  "sections": {{
    "essence": {{
      "variants": ["вариант A (финансы): описание что случилось, суммы, отчётность", "вариант B (операции): процессы нарушены, контроли", "вариант C (стратегия): репутация, соответствие требованиям"]
    }},
    "root_causes": {{
      "variants": ["причина1: как проявляется + контроль + проверка", "причина2: аналогично", "причина3: аналогично"]
    }},
    "business_consequences": {{
      "variants": ["A: денежный поток + прибыль + оборотка + сроки + штрафы + контрольная среда", "B: другой угол", "C: третий угол"]
    }},
    "cost_calculation": {{
      "variants": ["метод1: определение + формула + источники данных + ограничения + что делать если данных нет", "метод2: аналогично", "метод3: аналогично"]
    }},
    "risk_factors": {{
      "variants": ["фактор1: релевантность + как повышает вероятность/влияние + ранний индикатор + контроль", "фактор2: аналогично", "фактор3: аналогично"]
    }},
    "risk_cost_pxI": {{
      "variants": ["метод1 (EV): вероятность × влияние + калибровка + источники + защита оценки", "метод2 (сценарии): базовый/неблагоприятный/критический + расчёты", "метод3 (экспозиция): лимиты/штрафы/максимум"]
    }},
    "rsbu_checks": {{
      "variants": ["вариант A: ОБЯЗАТЕЛЬНО проводки Дт XX Кт YY сумма ZZZ руб + первичные документы (акты/накладные) + процедуры проверки аудитора", "вариант B: аналогично другие счета", "вариант C: аналогично третий вариант"]
    }},
    "ifrs_checks": {{
      "variants": ["вариант A: ОБЯЗАТЕЛЬНО стандарт IAS/IFRS №N + корректировки Dr/Cr + резервы IAS 37 + раскрытия", "вариант B: аналогично другие стандарты", "вариант C: аналогично третий вариант"]
    }},
    "measures": {{
      "variants": ["набор A: 2-4 корректирующих + 3-6 предупреждающих, каждая = действие/ответственный/срок/артефакт подтверждения/метрика эффекта/какую причину закрывает", "набор B: другие меры", "набор C: третий набор"]
    }},
    "final_summary": {{
      "variants": ["резюме A: причина → влияние на бизнес/метрики → РСБУ/МСФО → мероприятия → коммуникация руководству", "резюме B: другой угол", "резюме C: третий угол"]
    }}
  }}
}}

ЗАПРЕЩЕНЫ англицизмы. используй: денежные средства (не кэш), денежный поток (не кешфлоу), соответствие требованиям (не комплаенс).
"""


def build_regen_prompt(user_input: dict, selected: dict, section_key: str, old_variants: list, candidates: dict) -> str:
    user_str = str(user_input)
    sel_str = str(selected)
    cand_str = str(candidates)
    old_str = str(old_variants)
    
    return f"""РЕГЕНЕРАЦИЯ раздела {section_key}

user_input: {user_str}
selected: {sel_str}
candidates: {cand_str}

СТАРЫЕ варианты (НЕ ПОВТОРЯЙ): {old_str}

Дай 3 СОВЕРШЕННО НОВЫХ варианта с других углов (юридический/соответствие требованиям/управление рисками/технический).

ЗАПРЕЩЕНЫ англицизмы.

JSON:
{{
  "section_key": "{section_key}",
  "variants": ["новый вариант 1", "новый вариант 2", "новый вариант 3"]
}}
"""


def build_summary_prompt(approved_selections: dict, user_input: dict, selected: dict) -> str:
    user_str = str(user_input)
    sel_str = str(selected)
    app_str = str(approved_selections)
    
    return f"""собери ИТОГОВОЕ РЕЗЮМЕ для руководства из выбранных блоков.

user_input: {user_str}
selected категория/риск: {sel_str}

approved selections:
{app_str}

выдай JSON:
{{
  "summary": {{
    "root_cause": "2-4 строки: почему произошло",
    "business_impact": "2-4 строки: что ломает/теряем",
    "key_metrics": ["метрика 1", "метрика 2", "метрика 3"],
    "accounting_impact": "2-4 строки: РСБУ/МСФО куда смотреть и что искажается",
    "key_measures": ["мера 1 с артефактом", "мера 2", "мера 3"],
    "top_communication": {{
      "decision_needed": "1-2 решения которые нужны от руководства",
      "risk_if_not": "1-2 фразы что будет если не делать",
      "expected_effect": "диапазон эффекта + методика"
    }}
  }}
}}

тон: партнёрский, бизнесовый, максимум конкретики. ЗАПРЕЩЕНЫ англицизмы.
"""
