SYSTEM_PROMPT = """MASTER PROMPT v12 ‚Äî Big Four Audit Report Constructor

–†–û–õ–¨
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∞—É–¥–∏—Ç–æ—Ä –∏–∑ Big Four (Deloitte, PwC, EY, KPMG) —Å 20+ –ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –∞—É–¥–∏—Ç–µ –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π.
–¢–≤–æ–π —Ñ–æ–∫—É—Å –≤—Å–µ–≥–¥–∞ –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ: –∫–∞–∫ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–ª–∏—è—é—Ç –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.
–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—á–∞–µ—à—å –Ω–∞—Ä—É—à–µ–Ω–∏—è, –∞ –æ–±—ä—è—Å–Ω—è–µ—à—å –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –±–∏–∑–Ω–µ—Å–∞: –≤—ã—Ä—É—á–∫–∞, EBITDA, –°–°–î–ü, –æ–±–æ—Ä–æ—Ç–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª, —Ä–∏—Å–∫–∏.
–¢—ã —Å—Ç—Ä–æ–≥, –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω, –æ–ø–∏—Ä–∞–µ—à—å—Å—è –Ω–∞ —Ñ–∞–∫—Ç—ã –∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –±–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç.
–ò–∑–±–µ–≥–∞–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞ –∏–ª–∏ –º–æ—Ä–∞–ª–∏–∑–∞—Ç–æ—Ä—Å—Ç–≤–∞ - –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–æ–º, –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –±—å—ë—Ç –ø–æ –∫–∞—Ä–º–∞–Ω—É –∫–æ–º–ø–∞–Ω–∏–∏, –µ—ë –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º.

–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ê–í–ò–õ–ê –î–û–ö–ê–ó–ê–¢–ï–õ–¨–ù–û–°–¢–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï):
* –ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–¥—É–º—ã–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã: —Å—É–º–º—ã, –¥–∞—Ç—ã, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–æ–º–µ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤, —Å—Ç–∞—Ç—å–∏ –∑–∞—Ç—Ä–∞—Ç, —Å—á–µ—Ç–∞, –ø—Ä–æ–≤–æ–¥–∫–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–µ–ª–∏—á–∏–Ω—ã –≤–ª–∏—è–Ω–∏—è
* –õ—é–±–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ–º–µ—á–∞–π –æ–¥–Ω–∏–º –∏–∑ —Ç–µ–≥–æ–≤:
  - –§–ê–ö–¢ ‚Äî –ø—Ä—è–º–æ —Å–ª–µ–¥—É–µ—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
  - –ì–ò–ü–û–¢–ï–ó–ê ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è/—Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ (–ù–ï —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
  - –£–¢–û–ß–ù–ò–¢–¨ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å/–¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
* –ü—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ‚Üí –º–µ—Ö–∞–Ω–∏–∑–º ‚Üí –∫–∞–∫–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç—Ä–∞–¥–∞–µ—Ç ‚Üí –ø–æ—á–µ–º—É
* "–î–æ–¥—É–º—ã–≤–∞—Ç—å" –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ –≥–∏–ø–æ—Ç–µ–∑, —Å—Ç—Ä–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–µ–∫—Å—Ç—É, –≤—Å–µ–≥–¥–∞ —Å –±–ª–æ–∫–æ–º "–∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"
* –ï—Å–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ù–ï –∑–∞—Ç—Ä–æ–Ω—É—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º - –ø–∏—à–∏ "–ù–ï –í–õ–ò–Ø–ï–¢" –∏–ª–∏ "–ù–ï –†–ï–õ–ï–í–ê–ù–¢–ù–û". –ù–ï —Å–æ—á–∏–Ω—è–π –≤–ª–∏—è–Ω–∏–µ —Ç–∞–º, –≥–¥–µ –µ–≥–æ –Ω–µ—Ç!

–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
* –ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ –¥–µ–ª–æ–≤–æ–º —Ä—É—Å—Å–∫–æ–º. –ó–ê–ü–†–ï–©–ï–ù–´ –∞–Ω–≥–ª–∏—Ü–∏–∑–º—ã: –Ω–µ "–∫—ç—à/–∫–µ—à—Ñ–ª–æ—É/–∫–æ–º–ø–ª–∞–µ–Ω—Å/—Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä—ã", –∞ "–¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞/–¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫/—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º/–∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã"
* –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –º–∞–∫—Å–∏–º—É–º 150-200 —Å—Ç—Ä–æ–∫. –û–±—â–∏–π –≤—ã—Ö–æ–¥ –Ω–µ –±–æ–ª–µ–µ 16000 —Ç–æ–∫–µ–Ω–æ–≤
* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π <b>–∂–∏—Ä–Ω—ã–π</b> –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - —Å—É–º–º—ã, —Å—Ä–æ–∫–∏, –º–µ—Ç—Ä–∏–∫–∏, —Å—á–µ—Ç–∞, —Å—Ç–∞—Ç—å–∏
* –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML —Ç–µ–≥–∏, –ù–ï markdown: <b>—Ç–µ–∫—Å—Ç</b> –≤–º–µ—Å—Ç–æ **—Ç–µ–∫—Å—Ç**
* –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Å –ù–û–í–û–ô –°–¢–†–û–ö–ò —á–µ—Ä–µ–∑ \\n

–°–¢–†–£–ö–¢–£–†–ê –§–û–†–ú–£–õ–ò–†–û–í–ö–ò:
–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –î–û–õ–ñ–ù–û –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤:
1. –ß–¢–û –Ω–∞—Ä—É—à–µ–Ω–æ? (–Ω–æ—Ä–º–∞/–¥–æ–≥–æ–≤–æ—Ä/–õ–ù–ê)
2. –ì–î–ï? (–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ/–ø—Ä–æ—Ü–µ—Å—Å)
3. –ö–û–ì–î–ê? (–¥–∞—Ç–∞/–ø–µ—Ä–∏–æ–¥)
4. –ü–û–ß–ï–ú–£? (–ø—Ä–∏—á–∏–Ω–∞)
5. –ö–¢–û? (–§–ò–û + –¥–æ–ª–∂–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ)

–†–ê–ó–õ–ò–ß–ê–ô –§–ê–ö–¢ VS –†–ò–°–ö:
* –°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è = —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —É—â–µ—Ä–± (–£–ñ–ï —Å–ª—É—á–∏–ª–æ—Å—å)
* –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∏—Å–∫–∞ = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É—â–µ—Ä–± (–ú–û–ñ–ï–¢ —Å–ª—É—á–∏—Ç—å—Å—è)

–ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø:
* –í—ã–±–µ—Ä–∏ —Ç–æ–ø-2 –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∏ —Ç–æ–ø-2 —Ä–∏—Å–∫–∞ –∏–∑ candidates
* –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π confidence –∏–∑ candidates (—ç—Ç–æ semantic similarity)
* –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û –æ—Ü–µ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ü–û–õ–ù–û–ì–û –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
* –§–æ—Ä–º–∞—Ç: "1. [–ù–ê–ó–í–ê–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò –ë–ï–ó –ö–û–î–ê] ‚Äî –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ 1-2 —Å—Ç—Ä–æ–∫–∏ –ø–æ—á–µ–º—É —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–¥—Ö–æ–¥–∏—Ç"
"""


def build_user_prompt(user_input: dict, candidates: dict, regenerate: bool = False, old_variants: list = None) -> str:
    regen_note = ""
    if regenerate and old_variants:
        regen_note = f"""
–í–ê–ñ–ù–û: —ç—Ç–æ –†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø. 
–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: {old_variants}
–î–∞–π –°–û–í–ï–†–®–ï–ù–ù–û –ù–û–í–´–ï —É–≥–ª—ã. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π —Å—Ç–∞—Ä—ã–µ —Ç–µ–∑–∏—Å—ã.
"""
    
    user_str = str(user_input)
    cand_str = str(candidates)
    
    return f"""{regen_note}
user_input:
{user_str}

candidates:
{cand_str}

–í—ã–¥–∞–π JSON —Å—Ç—Ä–æ–≥–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

{{
  "selected": {{
    "deviation_category": {{
      "primary_id": "[–ù–ê–ó–í–ê–ù–ò–ï –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ë–ï–ó –∫–æ–¥–∞]",
      "alternatives": ["[–≤—Ç–æ—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ë–ï–ó –∫–æ–¥–∞]"],
      "rationale": "–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ primary –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (1-2 —Å—Ç—Ä–æ–∫–∏)"
    }},
    "risk": {{
      "primary_id": "[–ù–ê–ó–í–ê–ù–ò–ï —Ä–∏—Å–∫–∞ –ë–ï–ó –∫–æ–¥–∞]",
      "alternatives": ["[–≤—Ç–æ—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ë–ï–ó –∫–æ–¥–∞]"],
      "rationale": "–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ primary –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (1-2 —Å—Ç—Ä–æ–∫–∏)"
    }}
  }},
  "sections": {{
    "essence": {{
      "text": "<b>–û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ô:</b>\\n–§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö. [–æ–ø–∏—Å–∞–Ω–∏–µ 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π]\\n\\n<b>–§–ò–ù–ê–ù–°–û–í–´–ô:</b>\\n–§–æ–∫—É—Å –Ω–∞ —É—á—ë—Ç–µ, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏—Å–∫–∞–∂–µ–Ω–∏—è—Ö. [–æ–ø–∏—Å–∞–Ω–∏–µ 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π]\\n\\n<b>–ö–û–ú–ü–õ–ê–ï–ù–°:</b>\\n–§–æ–∫—É—Å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –Ω–æ—Ä–º–∞–º —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –±–∏–∑–Ω–µ—Å-—Ä–∏—Å–∫–∞. [–æ–ø–∏—Å–∞–Ω–∏–µ 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π]",
      "variants": ["–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π", "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π", "–∫–æ–º–ø–ª–∞–µ–Ω—Å"]
    }},
    "root_causes": {{
      "text": "<b>–°–ò–°–¢–ï–ú–ù–´–ô (–ø—Ä–æ—Ü–µ—Å—Å—ã/–∫–æ–Ω—Ç—Ä–æ–ª–∏):</b>\\n[–ø—Ä–∏—á–∏–Ω–∞ 1]\\n[–ø—Ä–∏—á–∏–Ω–∞ 2]\\n[–∫–∞–∫ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç—É]\\n\\n<b>–ß–ï–õ–û–í–ï–ß–ï–°–ö–ò–ô (–æ–±—É—á–µ–Ω–∏–µ/–º–æ—Ç–∏–≤–∞—Ü–∏—è):</b>\\n[–ø—Ä–∏—á–∏–Ω–∞ 1]\\n[–ø—Ä–∏—á–∏–Ω–∞ 2]\\n[–∫–∞–∫ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–æ—Å—Ç—É –∑–∞—Ç—Ä–∞—Ç/–ø–æ—Ç–µ—Ä–µ –∫–ª–∏–µ–Ω—Ç–æ–≤]\\n\\n<b>–í–ù–ï–®–ù–ò–ô (—Ä—ã–Ω–æ–∫/–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏):</b>\\n[–ø—Ä–∏—á–∏–Ω–∞ 1]\\n[–ø—Ä–∏—á–∏–Ω–∞ 2]\\n[–±–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç]",
      "variants": ["—Å–∏—Å—Ç–µ–º–Ω—ã–π", "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π", "–≤–Ω–µ—à–Ω–∏–π"]
    }},
    "cost_impact": {{
      "text": "üí∞ –û–¶–ï–ù–ö–ê –°–¢–û–ò–ú–û–°–¢–ò –ò –í–õ–ò–Ø–ù–ò–ï –ù–ê –ü–û–ö–ê–ó–ê–¢–ï–õ–ò\\n\\n...",
      "variants": ["—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏"]
    }},
    "formulas": {{
      "text": "üìê –§–û–†–ú–£–õ–´ –î–õ–Ø –†–ê–°–ß–Å–¢–ê\\n\\n<b>EBITDA:</b>\\n–ü—Ä–∏–±—ã–ª—å –æ—Ç –ø—Ä–æ–¥–∞–∂ + –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è + –ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–±–µ–∑ –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–∏) + –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ ‚àí –¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –∑–∞ —Å—á—ë—Ç —Ä–µ–∑–µ—Ä–≤–æ–≤ + –¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ª–∏–∑–∏–Ω–≥ (–±–µ–∑ –∫–≤–∞–ª —Ä–∞—Å—Ö–æ–¥–æ–≤) + (–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã –≤ EBITDA ‚àí –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –≤ EBITDA) ‚àí –†–∞—Å—Ö–æ–¥—ã –ø–æ —Å–æ—Ü —Å—Ñ–µ—Ä–µ + –ü—Ä–æ—á–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏\\n\\n<b>–°–°–î–ü (—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫):</b>\\n–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ‚àí –°–ø–∏—Å–∞–Ω–Ω—ã–µ –û–ù–ê/–û–ù–û ‚àí –ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏–≥—Ä—É–ø–ø–æ–≤—ã–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã + –ò–∑–º–µ–Ω–µ–Ω–∏–µ –û–ù–ê/–û–ù–û + –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –û–° –∏ –ù–ú–ê + –¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –õ–∏–∑–∏–Ω–≥ + –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ ‚àí –¢–µ–∫—É—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã –∑–∞ —Å—á—ë—Ç –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ + –°—Ä–µ–¥—Å—Ç–≤–∞ –°–†–§ + –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞ + –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ 91 —Å—á–µ—Ç—É + –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –≤ –∑–∞—á–µ—Ç –ö–ü–≠ + –†–µ—à–µ–Ω–∏—è –≤ –∑–æ–Ω–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ì–ö\\n\\n<b>–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –¢–†–£–î–ê:</b>\\n(–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å + –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ + –ù–∞–ª–æ–≥–∏ –∫—Ä–æ–º–µ –ù–Ω–ü + –ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è +/‚àí –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –û–°) / –ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å",
      "variants": ["—Ñ–æ—Ä–º—É–ª—ã"]
    }},
    "risk_cost_scenarios": {{
      "text": "<b>–°–¶–ï–ù–ê–†–ò–ô –ù–ò–ó–ö–ò–ô:</b>\\n...",
      "variants": ["–Ω–∏–∑–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π", "–≤—ã—Å–æ–∫–∏–π"]
    }},
    "risk_factors": {{
      "text": "<b>–í–ù–£–¢–†–ï–ù–ù–ò–ï —Ñ–∞–∫—Ç–æ—Ä—ã:</b>\\n...",
      "variants": ["–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ", "–≤–Ω–µ—à–Ω–∏–µ", "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ"]
    }},
    "rsbu_checks": {{
      "text": "<b>–†–°–ë–£ - –ü–†–û–í–û–î–ö–ò –ò –ü–†–û–í–ï–†–ö–ò</b>\\n\\n<b>–ü—Ä–æ–≤–æ–¥–∫–∏ –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è:</b>\\n<b>–î—Ç XX</b> –ö—Ç YY - [—Å—É–º–º–∞ —Ä—É–±] ([–ø–µ—Ä–≤–∏—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç: –ö–°-2/–¢–û–†–ì-12/–ú-11])\\n<b>–î—Ç XX</b> –ö—Ç YY - [—Å—É–º–º–∞ —Ä—É–±] ([–¥–æ–∫—É–º–µ–Ω—Ç])\\n\\n<b>–ü—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É–¥–∏—Ç–æ—Ä–∞:</b>\\n1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å [–¥–æ–∫—É–º–µ–Ω—Ç] ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å [—á—Ç–æ –∏–º–µ–Ω–Ω–æ]\\n2. –°–≤–µ—Ä–∏—Ç—å [–¥–∞–Ω–Ω—ã–µ] —Å [–∏—Å—Ç–æ—á–Ω–∏–∫]\\n3. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å [–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å]\\n\\n<b>–°—á–µ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</b>\\n–û–°–í —Å—á.[XX] - [—á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å]\\n–û–°–í —Å—á.[YY] - [—á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å]",
      "variants": ["–ø—Ä–æ–≤–æ–¥–∫–∏", "–ø—Ä–æ–≤–µ—Ä–∫–∏", "—Å—á–µ—Ç–∞"]
    }},
    "ifrs_checks": {{
      "text": "<b>–ú–°–§–û - –ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ò –ò –†–ê–°–ö–†–´–¢–ò–Ø</b>\\n\\n<b>–ü—Ä–∏–º–µ–Ω–∏–º—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç:</b> IAS/IFRS ‚Ññ[N] - [–Ω–∞–∑–≤–∞–Ω–∏–µ]\\n\\n<b>–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:</b>\\nDr [—Å—á—ë—Ç –ú–°–§–û] Cr [—Å—á—ë—Ç] - [—Å—É–º–º–∞] ([–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ])\\nDr [—Å—á—ë—Ç] Cr [—Å—á—ë—Ç] - [—Å—É–º–º–∞] ([–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ])\\n\\n<b>–†–µ–∑–µ—Ä–≤—ã:</b>\\nIAS 37 - [—Å—É–º–º–∞ —Ä–µ–∑–µ—Ä–≤–∞] ([–∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è])\\n\\n<b>–†–∞—Å–∫—Ä—ã—Ç–∏—è –≤ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è—Ö:</b>\\n‚Ä¢ [—á—Ç–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –ø—Ä–æ —Å—É–º–º—ã]\\n‚Ä¢ [—á—Ç–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –ø—Ä–æ —Ä–∏—Å–∫–∏]\\n‚Ä¢ [—á—Ç–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –ø—Ä–æ –æ—Ü–µ–Ω–∫–∏]",
      "variants": ["–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏", "—Ä–µ–∑–µ—Ä–≤—ã", "—Ä–∞—Å–∫—Ä—ã—Ç–∏—è"]
    }},
    "measures": {{
      "text": "<b>–ö–†–ê–¢–ö–û–°–†–û–ß–ù–´–ï –º–µ—Ä—ã:</b>\\n...",
      "variants": ["–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ", "—Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ", "–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ"]
    }},
    "export": {{
      "text": "üìÑ –≠–ö–°–ü–û–†–¢ –í WORD\\n\\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ email.\\n\\n–û—Ç—á—ë—Ç –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:\\n‚Ä¢ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é (–∏–∑ –±–∞–∑—ã 1–° –°–í–ö–∏–ê)\\n‚Ä¢ –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –∞–Ω–∞–ª–∏–∑–∞\\n‚Ä¢ –§–æ—Ä–º—É–ª—ã –º–µ—Ç—Ä–∏–∫\\n‚Ä¢ –ú–µ—Ä—ã —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º\\n\\n–í–≤–µ–¥–∏—Ç–µ: /email –≤–∞—à@email.ru",
      "variants": ["—ç–∫—Å–ø–æ—Ä—Ç"]
    }}
  }}
}}

–ö–†–ò–¢–ò–ß–ù–û - –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –î–õ–ò–ù–ï –ò –°–û–î–ï–†–ñ–ê–ù–ò–Æ:
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –ú–ê–ö–°–ò–ú–£–ú 800-1000 —Å–∏–º–≤–æ–ª–æ–≤
- –ü–†–ò–û–†–ò–¢–ï–¢ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É: —Ü–∏—Ñ—Ä—ã, —Å—É–º–º—ã, —Å—á–µ—Ç–∞, —Ñ–æ—Ä–º—É–ª—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´
- –í–´–†–ï–ó–ê–ô –≤–æ–¥—É: –æ–±—â–∏–µ —Å–ª–æ–≤–∞, –ø–æ–≤—Ç–æ—Ä—ã, –æ—á–µ–≤–∏–¥–Ω–æ—Å—Ç–∏
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–∫—Ä–æ–π –≤—Å–µ JSON —Ç–µ–≥–∏ –≤ –∫–æ–Ω—Ü–µ
- –ï—Å–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ù–ï –∑–∞—Ç—Ä–æ–Ω—É—Ç - –ø–∏—à–∏ "–ù–ï –í–õ–ò–Ø–ï–¢" –∏–ª–∏ "–ù–ï –†–ï–õ–ï–í–ê–ù–¢–ù–û", –ù–ï —Å–æ—á–∏–Ω—è–π –≤–ª–∏—è–Ω–∏–µ!

üö® –ö–†–ò–¢–ò–ß–ù–û - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê JSON:
–î–ª—è –ö–ê–ñ–î–û–ì–û —Ä–∞–∑–¥–µ–ª–∞ –≤ sections –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–π –û–ë–ê –ø–æ–ª—è:
{{
  "text": "...",
  "variants": ["–∑–∞–≥–ª—É—à–∫–∞1", "–∑–∞–≥–ª—É—à–∫–∞2", "–∑–∞–≥–ª—É—à–∫–∞3"]
}}

–ü—Ä–∏–º–µ—Ä –ü–†–ê–í–ò–õ–¨–ù–û–ì–û —Ñ–æ—Ä–º–∞—Ç–∞:
"essence": {{
  "text": "<b>–û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ô :</b>\\n...\\n\\n<b>–§–ò–ù–ê–ù–°–û–í–´–ô :</b>\\n...",
  "variants": ["–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π", "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π", "–∫–æ–º–ø–ª–∞–µ–Ω—Å"]
}}

–ë–ï–ó –ø–æ–ª—è "variants" JSON –ù–ï –í–ê–õ–ò–î–ï–ù! –î–æ–±–∞–≤–ª—è–π –µ–≥–æ –≤ –ö–ê–ñ–î–´–ô —Ä–∞–∑–¥–µ–ª!

–ó–ê–ü–†–ï–©–ï–ù–´ –∞–Ω–≥–ª–∏—Ü–∏–∑–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π: –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–Ω–µ –∫—ç—à), –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (–Ω–µ –∫–µ—à—Ñ–ª–æ—É), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (–Ω–µ –∫–æ–º–ø–ª–∞–µ–Ω—Å).
"""


def build_regen_prompt(user_input: dict, selected: dict, section_key: str, old_variants: list, candidates: dict) -> str:
    user_str = str(user_input)
    sel_str = str(selected)
    cand_str = str(candidates)
    old_str = str(old_variants)
    
    return f"""–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø —Ä–∞–∑–¥–µ–ª–∞ {section_key}

user_input: {user_str}
selected: {sel_str}
candidates: {cand_str}

–°–¢–ê–†–´–ô –∫–æ–Ω—Ç–µ–Ω—Ç (–ù–ï –ü–û–í–¢–û–†–Ø–ô): {old_str}

–î–∞–π –°–û–í–ï–†–®–ï–ù–ù–û –ù–û–í–´–ô –∫–æ–Ω—Ç–µ–Ω—Ç —Å –¥—Ä—É–≥–æ–≥–æ —É–≥–ª–∞.

–ó–ê–ü–†–ï–©–ï–ù–´ –∞–Ω–≥–ª–∏—Ü–∏–∑–º—ã.

JSON:
{{
  "section_key": "{section_key}",
  "text": "–Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç"
}}
"""
